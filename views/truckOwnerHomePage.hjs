<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Owner Dashboard - GIU Food Truck</title>
    <link rel="stylesheet" href="/styles/bootstrap.min.css">
    <link rel="stylesheet" href="./styles/style.css">

</head>
<body>
    <!-- Navigation -->

<nav class="custom-nav">
    <div>
        <strong style="color: var(--accent-orange);">GIU</strong> FoodTruck
    </div>
    <div class="nav-links d-none d-md-block">
        <a href="/truckOwnerHomePage">üöö Dashboard</a>
        <a href="#" onclick="viewMyTruck()">üçî My Trucks</a>
        <a href="#" onclick="viewMyMenuItems()">üõí Menu (<span id="cartCount">0</span>)</a>
        <a href="#" onclick="viewTruckOrders()">üìã  Orders</a>
    </div>
    <a href="#" onclick="logout()" style="color: var(--accent-orange); text-decoration: none; font-weight: 600;">Logout</a>
</nav>
    <div class="container">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <h1>Welcome, <span id="userName">Truck Owner</span>!</h1>
            <p class="lead">Manage your food truck business</p>
            <p><small>Truck: <span id="truckName">Loading...</span> | Status: <span id="truckStatus">Loading...</span></small></p>
        </div>

        <!-- Dashboard Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Truck Info</h5>
                        <p class="card-text">View and update your truck details</p>
                        <button class="btn btn-primary" onclick="viewMyTruck()">
                            View Truck
                        </button>
                        <button class="btn btn-outline-primary mt-2" onclick="updateTruckStatus()">
                            Update Status
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Menu Items</h5>
                        <p class="card-text">Manage your food menu</p>
                        <button class="btn btn-success" onclick="viewMyMenuItems()">
                            View Menu
                        </button>
                        <button class="btn btn-outline-success mt-2" onclick="showAddMenuItemModal()">
                            Add Item
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Orders</h5>
                        <p class="card-text">View and manage orders</p>
                        <button class="btn btn-warning" onclick="viewTruckOrders()">
                            View Orders (<span id="orderCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Analytics</h5>
                        <p class="card-text">View sales and reports</p>
                        <button class="btn btn-info" onclick="viewReports()">
                            View Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="row">
            <!-- Left Column: Menu Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>My Menu Items</h5>
                        <button class="btn btn-success btn-sm" onclick="showAddMenuItemModal()">
                            + Add New
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="menuItemsContainer">
                            <p class="text-center">Loading menu items...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Recent Orders -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Recent Orders</h5>
                        <button class="btn btn-warning btn-sm" onclick="viewTruckOrders()">
                            View All
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="recentOrdersContainer">
                            <p class="text-center">Loading recent orders...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Truck Info Card -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Truck Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Truck Name:</strong> <span id="infoTruckName">Loading...</span></p>
                                <p><strong>Truck Status:</strong> <span id="infoTruckStatus" class="badge badge-success">Loading...</span></p>
                                <p><strong>Order Status:</strong> <span id="infoOrderStatus" class="badge badge-info">Loading...</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Owner:</strong> <span id="infoOwnerName">Loading...</span></p>
                                <p><strong>Email:</strong> <span id="infoOwnerEmail">Loading...</span></p>
                                <p><strong>Truck ID:</strong> <span id="infoTruckId">Loading...</span></p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" onclick="toggleOrderStatus()" id="toggleStatusBtn">
                                Toggle Order Availability
                            </button>
                            <button class="btn btn-outline-danger ml-2" onclick="logout()">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Menu Item Modal -->
    <div class="modal fade" id="addMenuItemModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Menu Item</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addMenuItemForm">
                        <div class="form-group">
                            <label for="itemName">Item Name *</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemPrice">Price *</label>
                            <input type="number" class="form-control" id="itemPrice" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">Category *</label>
                            <select class="form-control" id="itemCategory" required>
                                <option value="">Select Category</option>
                                <option value="Main Course">Main Course</option>
                                <option value="Sides">Sides</option>
                                <option value="Drinks">Drinks</option>
                                <option value="Desserts">Desserts</option>
                                <option value="Appetizers">Appetizers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemDescription">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMenuItem()">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Menu Item Modal -->
    <div class="modal fade" id="editMenuItemModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Menu Item</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editMenuItemForm">
                        <input type="hidden" id="editItemId">
                        <div class="form-group">
                            <label for="editItemName">Item Name *</label>
                            <input type="text" class="form-control" id="editItemName" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemPrice">Price *</label>
                            <input type="number" class="form-control" id="editItemPrice" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemCategory">Category *</label>
                            <select class="form-control" id="editItemCategory" required>
                                <option value="">Select Category</option>
                                <option value="Main Course">Main Course</option>
                                <option value="Sides">Sides</option>
                                <option value="Drinks">Drinks</option>
                                <option value="Desserts">Desserts</option>
                                <option value="Appetizers">Appetizers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editItemDescription">Description</label>
                            <textarea class="form-control" id="editItemDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateMenuItem()">Update Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details - #<span id="orderDetailsId"></span></h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Customer:</strong> <span id="orderCustomerName"></span></p>
                            <p><strong>Order Status:</strong> <span id="orderStatusBadge" class="badge"></span></p>
                            <p><strong>Total Price:</strong> $<span id="orderTotalPrice"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Scheduled Pickup:</strong> <span id="orderPickupTime"></span></p>
                            <p><strong>Estimated Ready:</strong> <span id="orderEstimatedTime"></span></p>
                            <p><strong>Order Date:</strong> <span id="orderCreatedAt"></span></p>
                        </div>
                    </div>
                    <hr>
                    <h6>Order Items:</h6>
                    <div id="orderItemsList" class="mt-3">
                        <!-- Order items will be loaded here -->
                    </div>
                    <hr>
                    <div class="form-group">
                        <label for="updateOrderStatus">Update Order Status:</label>
                        <select class="form-control" id="updateOrderStatus">
                            <option value="pending">Pending</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready for Pickup</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="updateEstimatedTime">Update Estimated Ready Time (optional):</label>
                        <input type="datetime-local" class="form-control" id="updateEstimatedTime">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include jQuery and Bootstrap -->
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script>
    // Global variables
    let currentOrderId = null;
    let myTruckInfo = null;
    
    $(document).ready(function() {
        console.log('=== TRUCK OWNER DASHBOARD LOADED ===');
        
        // Load user info
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = localStorage.getItem('authToken');
        
        console.log('User from localStorage:', user);
        console.log('Token from localStorage:', token ? 'Present' : 'Missing');
        
        if (!token) {
            alert('No authentication token found. Please login again.');
            window.location.href = '/login';
            return;
        }
        
        if (user.name) {
            $('#userName').text(user.name);
            $('#infoOwnerName').text(user.name);
            $('#infoOwnerEmail').text(user.email);
        }
        
        // Load truck info and data
        loadTruckInfo();
        loadMenuItems();
        loadRecentOrders();
        
        console.log('‚úÖ Dashboard ready');
    });
    
    // Load truck information
    function loadTruckInfo() {
        const token = localStorage.getItem('authToken');
        
        $.ajax({
            url: '/api/v1/trucks/myTruck',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(truck) {
                console.log('Truck info received:', truck);
                myTruckInfo = truck;
                
                // Update UI
                $('#truckName').text(truck.truckname);
                $('#truckStatus').text(truck.truckstatus);
                $('#infoTruckName').text(truck.truckname);
                $('#infoTruckId').text(truck.truckid);
                $('#infoTruckStatus').text(truck.truckstatus).removeClass().addClass('badge badge-success');
                $('#infoOrderStatus').text(truck.orderstatus).removeClass().addClass('badge badge-info');
                
                // Update toggle button text
                const toggleBtn = $('#toggleStatusBtn');
                if (truck.orderstatus === 'available') {
                    toggleBtn.text('Set to Unavailable');
                    toggleBtn.removeClass('btn-danger').addClass('btn-success');
                } else {
                    toggleBtn.text('Set to Available');
                    toggleBtn.removeClass('btn-success').addClass('btn-danger');
                }
            },
            error: function(xhr) {
                console.error('Truck info error:', xhr);
                $('#truckName').text('Error loading');
                $('#truckStatus').text('Error');
            }
        });
    }
    
    // Load menu items
    function loadMenuItems() {
        const token = localStorage.getItem('authToken');
        
        $.ajax({
            url: '/api/v1/menuItem/view',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(menuItems) {
                console.log('Menu items received:', menuItems);
                const container = $('#menuItemsContainer');
                container.empty();
                
                if (menuItems.length === 0) {
                    container.html('<p class="text-center">No menu items yet. Add your first item!</p>');
                    return;
                }
                
                menuItems.forEach(item => {
                    const menuItem = `
                    <div class="menu-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>${item.name}</h5>
                                <p class="category mb-1">${item.category}</p>
                                <p class="mb-1">${item.description || 'No description'}</p>
                                <p class="price mb-0">$${parseFloat(item.price).toFixed(2)}</p>
                                <small class="text-muted">Status: ${item.status} | Created: ${new Date(item.createdat).toLocaleDateString()}</small>
                            </div>
                            <div>
                                <button class="btn btn-warning btn-sm" onclick="showEditMenuItemModal(${item.itemid}, '${item.name}', ${item.price}, '${item.category}', '${item.description || ''}')">
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm ml-1" onclick="deleteMenuItem(${item.itemid}, '${item.name}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                    container.append(menuItem);
                });
            },
            error: function(xhr) {
                console.error('Menu items error:', xhr);
                $('#menuItemsContainer').html('<p class="text-center text-danger">Error loading menu items</p>');
            }
        });
    }
    
    // Load recent orders
    function loadRecentOrders() {
        const token = localStorage.getItem('authToken');
        
        $.ajax({
            url: '/api/v1/order/truckOrders',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(orders) {
                console.log('Orders received:', orders);
                const container = $('#recentOrdersContainer');
                const orderCount = $('#orderCount');
                
                orderCount.text(orders.length);
                
                container.empty();
                
                if (orders.length === 0) {
                    container.html('<p class="text-center">No orders yet.</p>');
                    return;
                }
                
                // Show only recent 5 orders
                const recentOrders = orders.slice(0, 5);
                
                recentOrders.forEach(order => {
                    const statusClass = getStatusClass(order.orderstatus);
                    const orderDate = new Date(order.createdat).toLocaleDateString();
                    const pickupTime = new Date(order.scheduledpickuptime).toLocaleString();
                    
                    const orderItem = `
                    <div class="order-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>Order #${order.orderid}</h6>
                                <p class="mb-1"><strong>Customer:</strong> ${order.customername}</p>
                                <p class="mb-1"><strong>Total:</strong> $${parseFloat(order.totalprice).toFixed(2)}</p>
                                <p class="mb-1"><strong>Pickup:</strong> ${pickupTime}</p>
                                <small class="text-muted">Placed: ${orderDate}</small>
                            </div>
                            <div class="text-right">
                                <span class="badge ${getStatusBadgeClass(order.orderstatus)}">${order.orderstatus}</span>
                                <div class="mt-2">
                                    <button class="btn btn-info btn-sm" onclick="viewOrderDetails(${order.orderid})">
                                        View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    container.append(orderItem);
                });
                
                if (orders.length > 5) {
                    container.append('<p class="text-center mt-2"><small>Showing 5 of ' + orders.length + ' orders</small></p>');
                }
            },
            error: function(xhr) {
                console.error('Orders error:', xhr);
                $('#recentOrdersContainer').html('<p class="text-center text-danger">Error loading orders</p>');
            }
        });
    }
    
    // Show add menu item modal
    function showAddMenuItemModal() {
        $('#itemName').val('');
        $('#itemPrice').val('');
        $('#itemCategory').val('');
        $('#itemDescription').val('');
        $('#addMenuItemModal').modal('show');
    }
    
    // Add menu item
    function addMenuItem() {
        const token = localStorage.getItem('authToken');
        const itemName = $('#itemName').val();
        const itemPrice = parseFloat($('#itemPrice').val());
        const itemCategory = $('#itemCategory').val();
        const itemDescription = $('#itemDescription').val();
        
        if (!itemName || !itemPrice || !itemCategory) {
            alert('Please fill in all required fields (Name, Price, Category)');
            return;
        }
        
        if (itemPrice <= 0) {
            alert('Price must be greater than 0');
            return;
        }
        
        console.log('Adding menu item:', { itemName, itemPrice, itemCategory, itemDescription });
        
        $.ajax({
            url: '/api/v1/menuItem/new',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                name: itemName,
                price: itemPrice,
                category: itemCategory,
                description: itemDescription
            }),
            success: function(response) {
                console.log('Menu item added:', response);
                $('#addMenuItemModal').modal('hide');
                alert('Menu item added successfully!');
                loadMenuItems(); // Refresh menu
            },
            error: function(xhr) {
                console.error('Add menu item error:', xhr);
                const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                alert('Error adding menu item: ' + errorMsg);
            }
        });
    }
    
    // Show edit menu item modal
    function showEditMenuItemModal(itemId, name, price, category, description) {
        $('#editItemId').val(itemId);
        $('#editItemName').val(name);
        $('#editItemPrice').val(price);
        $('#editItemCategory').val(category);
        $('#editItemDescription').val(description);
        $('#editMenuItemModal').modal('show');
    }
    
    // Update menu item
    function updateMenuItem() {
        const token = localStorage.getItem('authToken');
        const itemId = $('#editItemId').val();
        const itemName = $('#editItemName').val();
        const itemPrice = parseFloat($('#editItemPrice').val());
        const itemCategory = $('#editItemCategory').val();
        const itemDescription = $('#editItemDescription').val();
        
        if (!itemName || !itemPrice || !itemCategory) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('Updating menu item:', itemId, { itemName, itemPrice, itemCategory, itemDescription });
        
        $.ajax({
            url: `/api/v1/menuItem/edit/${itemId}`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                name: itemName,
                price: itemPrice,
                category: itemCategory,
                description: itemDescription
            }),
            success: function(response) {
                console.log('Menu item updated:', response);
                $('#editMenuItemModal').modal('hide');
                alert('Menu item updated successfully!');
                loadMenuItems(); // Refresh menu
            },
            error: function(xhr) {
                console.error('Update menu item error:', xhr);
                const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                alert('Error updating menu item: ' + errorMsg);
            }
        });
    }
    
    // Delete menu item
    function deleteMenuItem(itemId, itemName) {
        if (!confirm(`Are you sure you want to delete "${itemName}"? This will set it to unavailable.`)) {
            return;
        }
        
        const token = localStorage.getItem('authToken');
        
        $.ajax({
            url: `/api/v1/menuItem/delete/${itemId}`,
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                console.log('Menu item deleted:', response);
                alert('Menu item deleted successfully!');
                loadMenuItems(); // Refresh menu
            },
            error: function(xhr) {
                console.error('Delete menu item error:', xhr);
                const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                alert('Error deleting menu item: ' + errorMsg);
            }
        });
    }
    
    // View order details
    function viewOrderDetails(orderId) {
        currentOrderId = orderId;
        const token = localStorage.getItem('authToken');
        
        $.ajax({
            url: `/api/v1/order/truckOwner/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(order) {
                console.log('Order details:', order);
                
                // Update modal with order info
                $('#orderDetailsId').text(order.orderid);
                $('#orderCustomerName').text(order.customername || 'N/A');
                $('#orderTotalPrice').text(parseFloat(order.totalprice).toFixed(2));
                $('#orderPickupTime').text(new Date(order.scheduledpickuptime).toLocaleString());
                $('#orderEstimatedTime').text(new Date(order.estimatedearliestpickup).toLocaleString());
                $('#orderCreatedAt').text(new Date(order.createdat).toLocaleString());
                
                // Status badge
                const statusBadge = $('#orderStatusBadge');
                statusBadge.text(order.orderstatus);
                statusBadge.removeClass().addClass('badge ' + getStatusBadgeClass(order.orderstatus));
                
                // Set current status in dropdown
                $('#updateOrderStatus').val(order.orderstatus);
                
                // Clear and populate order items
                const itemsList = $('#orderItemsList');
                itemsList.empty();
                
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        const itemRow = `
                        <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                            <div>
                                <strong>${item.itemname}</strong><br>
                                <small>Quantity: ${item.quantity}</small>
                            </div>
                            <div class="text-right">
                                <div>$${parseFloat(item.price).toFixed(2)} each</div>
                                <div><strong>$${itemTotal.toFixed(2)}</strong></div>
                            </div>
                        </div>
                        `;
                        itemsList.append(itemRow);
                    });
                } else {
                    itemsList.html('<p class="text-center">No items found</p>');
                }
                
                // Show modal
                $('#orderDetailsModal').modal('show');
            },
            error: function(xhr) {
                console.error('Order details error:', xhr);
                alert('Error loading order details: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    }
    
    // Update order status
    function updateOrderStatus() {
        if (!currentOrderId) return;
        
        const token = localStorage.getItem('authToken');
        const newStatus = $('#updateOrderStatus').val();
        const estimatedTime = $('#updateEstimatedTime').val();
        
        console.log('Updating order status:', currentOrderId, { newStatus, estimatedTime });
        
        const data = { orderStatus: newStatus };
        if (estimatedTime) {
            data.estimatedEarliestPickup = new Date(estimatedTime).toISOString();
        }
        
        $.ajax({
            url: `/api/v1/order/updateStatus/${currentOrderId}`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(data),
            success: function(response) {
                console.log('Order status updated:', response);
                $('#orderDetailsModal').modal('hide');
                alert('Order status updated successfully!');
                loadRecentOrders(); // Refresh orders
            },
            error: function(xhr) {
                console.error('Update order status error:', xhr);
                const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                alert('Error updating order status: ' + errorMsg);
            }
        });
    }
    
    // Toggle order status (available/unavailable)
    function toggleOrderStatus() {
        if (!myTruckInfo) return;
        
        const token = localStorage.getItem('authToken');
        const newStatus = myTruckInfo.orderstatus === 'available' ? 'unavailable' : 'available';
        
        if (!confirm(`Are you sure you want to set your truck to "${newStatus}" for orders?`)) {
            return;
        }
        
        $.ajax({
            url: '/api/v1/trucks/updateOrderStatus',
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ orderStatus: newStatus }),
            success: function(response) {
                console.log('Truck status updated:', response);
                alert(`Truck order status updated to "${newStatus}"!`);
                loadTruckInfo(); // Refresh truck info
            },
            error: function(xhr) {
                console.error('Update truck status error:', xhr);
                const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                alert('Error updating truck status: ' + errorMsg);
            }
        });
    }
    
    // Original functions (for backward compatibility)
    function viewMyTruck() {
        loadTruckInfo();
        alert('Truck information refreshed!');
    }
    
    function viewMyMenuItems() {
        loadMenuItems();
        alert('Menu items refreshed!');
    }
    
    function viewTruckOrders() {
        loadRecentOrders();
        alert('Orders refreshed!');
    }
    
    function updateTruckStatus() {
        toggleOrderStatus();
    }
    
    function viewReports() {
        alert('Analytics dashboard coming soon!\nThis would show sales reports and customer analytics.');
    }
    
    // Helper functions
    function getStatusClass(status) {
        switch(status.toLowerCase()) {
            case 'pending': return 'status-pending';
            case 'preparing': return 'status-preparing';
            case 'ready': return 'status-ready';
            case 'completed': return 'status-completed';
            case 'cancelled': return 'status-cancelled';
            default: return '';
        }
    }
    
    function getStatusBadgeClass(status) {
        switch(status.toLowerCase()) {
            case 'pending': return 'badge-warning';
            case 'preparing': return 'badge-info';
            case 'ready': return 'badge-success';
            case 'completed': return 'badge-secondary';
            case 'cancelled': return 'badge-danger';
            default: return 'badge-light';
        }
    }
    
    // Logout
    function logout() {
        const token = localStorage.getItem('authToken');
        
        if (token) {
            $.ajax({
                url: '/api/v1/user/logout',
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function() {
                    console.log('Logout successful');
                    clearAndRedirect();
                },
                error: function() {
                    console.log('Logout API failed, clearing locally');
                    clearAndRedirect();
                }
            });
        } else {
            clearAndRedirect();
        }
    }
    
    function clearAndRedirect() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
        window.location.href = '/login';
    }
    </script>
</body>
</html>